---
title: 分布式事务解决方案之TCC
date: 2022-03-29 19:11:14
tags:
categories:
- Cloud
- 分布式
---


### 1. TCC分布式事务模型

#### 1.1需要业务系统提供三段业务逻辑：

1. 一阶段: 初步操作 Try：完成所有业务检查，预留必须的业务资源。

2. 二阶段: 确认操作 Confirm：真正执行的业务逻辑，不做任何业务检查，只使用 Try 阶段预留的业务资源。因此，只要 Try 操作成功，Confirm 必须能成功。另外，Confirm 操作需满足幂等性，保证一笔分布式事务能且只能成功一次。

3. 二阶段: 取消操作 Cancel：释放 Try 阶段预留的业务资源。同样的，Cancel 操作也需要满足幂等性。

其中一个事务中`确认`和`取消`只有一个会执行. 所以 TCC 模型是两阶段操作模型.

#### 1.2 需要实现的功能

- 支持空回滚: 没有执行一阶段Try, 调用二阶段回滚方法返回成功
- 幂等: 所有方法执行一次和多次结果一样
- 防悬挂: 对于同一个全局事务, 执行了二阶段操作, 不能再执行一阶段操作
- 并发控制: 一个全局事务完成了一阶段之后, 不需要完成二阶段操作, 其他事务即可操作该记录

### 2. 账务系统TCC模型设计
以金融核心链路里的账务服务来分析一下。首先一个最简化的账务模型就是图中所列，每个用户或商户有一个账户及其可用余额。然后，分析下账务服务的所有业务逻辑操作，无论是交易、充值、转账、退款等，都可以认为是对账户的加钱与扣钱。

![](http://101.132.193.91:4999/server/../Public/Uploads/2020-08-17/5f3a470f0ab1f.png)

可以把账务系统拆分成两套 TCC 接口，即两个 TCC Resource:
 - 一个是加钱 TCC 接口;
 - 一个是扣钱 TCC 接口。

#### 2.1扣钱流程
 ![](http://101.132.193.91:4999/server/../Public/Uploads/2020-08-17/5f3a47ac6b477.png)

- 检查悬挂, Try 操作账户扣钱, 插入一条流水记录, 状态为`PROCESSING`
- Confirm 不操作账户, 更新记录状态为 `CONFIRM`
- Cancel 读取流水记录, 操作账户加钱, 更新记录状态为 `CANCEL`

#### 2.2 加钱流程

- 检查悬挂, Try 不操作账户, 插入一条流水记录, 状态为`PROCESSING`
- Confirm 读取流水记录, 给账户加钱, 更新记录状态为 `CONFIRM`
- Cancel 不操作账户, 更新记录状态为 `CANCEL`

### 3. 代码实现

#### 3.1 数据库实现

- 账户表
- 转账事务表
![](2022/03/28/Cloud/distributed/分布式事务解决方案之TCC/account_table.jpg)

{% asset_img 分布式事务解决方案之TCC/account_table.jpg 这是一个图片%}

#### 3.2 操作流程

扣钱操作: 扣减n 元


| 操作  		|转账事务表 												| 账户表 					  |
| ------------ | ------------		  										|   ------------     |
|  Try 			| 检查悬挂, 插入一条记录, 状态为`进行中`  | `money`减去n |
|  Confirm |根据`gtx_id`查询记录, 并标记为`已确认`	| 	不操作 	   		|
| Cancel	  | 根据`gtx_id`查询记录, 获取`amount`, 标记为`已取消`|`money`增加n    |


加钱操作: 增加n 元

| 操作  		|转账事务表 															| 账户表 					  |
| ------------ | ------------		  													|   ------------     		|
|  Try 			| 检查悬挂, 插入一条记录, 状态为`进行中` 			 | 不操作 					|
|  Confirm |根据`gtx_id`查询记录,获取`amount`, 并标记为`已确认` | 	`money`增加n 	|
| Cancel	  | 根据`gtx_id`查询记录,  标记为`已取消`|不操作		   |


- `检查悬挂`: 根据`gtx_id`查询记录, 如果存在则不操作, 直接返回.

#### 3.3 功能实现
##### 3.3.1 空回滚

在`Cancel`操作中, 对转账事务表, 根据`gtx_id`查询记录, 如果没有则直接返回.

##### 3.3.2 幂等

- Try: 通过`检查悬挂`实现
- Confirm: 通过根据`gtx_id`查询转账事务表记录,如果状态不是`进行中`,则不操作, 返回.
- Cancel: 同上.

##### 3.3.3 防悬挂

在Try阶段通过`检查悬挂`实现.

##### 3.3.4 并发控制

通过`转账事务表`的事务记录实现并发隔离, `Try`, `Confirm`, `Cancel`每个操作各自都是原子的.

扣钱操作: 事务1 扣减m 元, 事务2 扣减 n元

| 操作  		| 事务1 												| 事务2 					  |
| ------------ | ------------		  										|   ------------     |
|  Try 			|当前`money`减去m  | `money`在`money`减去m的基础上减去n |
|  Confirm |不操作	| 	不操作 	   								|
| Cancel	  |当前`money`增加m |当前`money`增加n    |


加钱操作:事务1 增加m 元, 事务2 增加n元

| 操作  		| 事务1 												| 事务2 					  |
| ------------ | ------------		  										|   ------------     |
|  Try 			|不操作	| 	不操作 	   								|
|  Confirm 			|当前`money`增加m  | `money`在`money`增加m的基础上增加n |
| Cancel	  |不操作	| 	不操作 	   								|
